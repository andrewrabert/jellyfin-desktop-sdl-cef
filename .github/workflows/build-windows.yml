name: build-windows

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  MPV_VERSION: "20251214-git-f7be2ee"
  MPV_VERSION_ARM64: "20250302-git-ee07dcf"
  SDL_VERSION: "3.2.14"

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "0.0.0")
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Version: ${VERSION}"

      - name: Cache CEF
        uses: actions/cache@v4
        with:
          path: |
            third_party/cef
            third_party/cef_binary_*
          key: cef-windows-${{ matrix.arch }}-${{ hashFiles('dev/download_cef.py') }}
          restore-keys: |
            cef-windows-${{ matrix.arch }}-

      - name: Download CEF
        run: |
          python dev/download_cef.py --platform ${{ matrix.arch == 'arm64' && 'windowsarm64' || 'windows64' }}

      - name: Download SDL3
        shell: bash
        run: |
          curl -L "https://github.com/libsdl-org/SDL/releases/download/release-${SDL_VERSION}/SDL3-devel-${SDL_VERSION}-VC.zip" -o sdl3.zip
          7z x sdl3.zip -othird_party
          mv "third_party/SDL3-${SDL_VERSION}" third_party/SDL

      - name: Download libmpv
        shell: bash
        run: |
          # Preserve submodule headers (has render_vk.h), use prebuilt DLL
          mv third_party/mpv/include third_party/mpv-include
          rm -rf third_party/mpv
          mkdir -p third_party/mpv/lib
          mv third_party/mpv-include third_party/mpv/include
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            curl -L "https://sourceforge.net/projects/mpv-player-windows/files/libmpv/mpv-dev-aarch64-${MPV_VERSION_ARM64}.7z/download" -o mpv.7z
          else
            curl -L "https://sourceforge.net/projects/mpv-player-windows/files/libmpv/mpv-dev-x86_64-v3-${MPV_VERSION}.7z/download" -o mpv.7z
          fi
          7z x mpv.7z -ompv-tmp
          mv mpv-tmp/libmpv-2.dll third_party/mpv/lib/
          # Generate .def file from DLL (package doesn't include it)
          cd third_party/mpv/lib
          gendef libmpv-2.dll

      - name: Install Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-query-version: 1.3.290.0
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch == 'arm64' && 'amd64_arm64' || 'amd64' }}

      - name: Generate mpv import library
        shell: cmd
        run: |
          cd third_party\mpv\lib
          lib /def:libmpv-2.def /out:mpv.lib /MACHINE:${{ matrix.arch == 'arm64' && 'ARM64' || 'X64' }}

      - name: Configure and build
        shell: cmd
        run: |
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=RelWithDebInfo ^
            -DCMAKE_SYSTEM_PROCESSOR=${{ matrix.arch == 'arm64' && 'ARM64' || 'AMD64' }} ^
            -DSDL3_DIR=%CD%\third_party\SDL\cmake ^
            -DEXTERNAL_MPV_DIR=%CD%\third_party\mpv
          cmake --build build

      - name: Create package
        shell: cmd
        run: |
          cmake --install build --prefix build/install
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: build/jellyfin-desktop-cef-*.zip
