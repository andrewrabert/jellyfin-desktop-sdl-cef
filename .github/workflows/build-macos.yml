name: build-macos

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15
            arch: arm64
          - runner: macos-15-intel
            arch: x86_64
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Determine version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "0.0.0")
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Version: ${VERSION}"

      - name: Install build tools
        run: |
          brew install cmake ninja meson pkg-config

      - name: Install mpv dependencies
        run: |
          brew install \
            ffmpeg \
            libplacebo \
            libass \
            luajit \
            vulkan-loader \
            vulkan-headers \
            molten-vk \
            sdl3 \
            lcms2 \
            libunibreak \
            zimg

      - name: Cache CEF
        uses: actions/cache@v4
        with:
          path: |
            third_party/cef
            third_party/cef_binary_*
          key: cef-macos-${{ matrix.arch }}-${{ hashFiles('dev/download_cef.py') }}
          restore-keys: |
            cef-macos-${{ matrix.arch }}-

      - name: Download CEF
        run: |
          python3 dev/download_cef.py

      - name: Configure and build
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Create app bundle
        run: |
          cmake --install build --prefix build/output

      - name: Create DMG
        run: |
          brew install create-dmg
          APP_NAME="Jellyfin Media Player"
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          DMG_NAME="JellyfinMediaPlayer-${VERSION}-macos-${ARCH}.dmg"

          # create-dmg returns non-zero if icon positioning fails (no icon), ignore that
          create-dmg \
            --volname "Jellyfin Media Player v${VERSION}" \
            --no-internet-enable \
            --window-size 500 300 \
            --icon-size 100 \
            --icon "${APP_NAME}.app" 125 150 \
            --app-drop-link 375 150 \
            "${DMG_NAME}" "build/output/${APP_NAME}.app" || true

          # Verify DMG was created
          if [ ! -f "${DMG_NAME}" ]; then
            echo "DMG creation failed"
            exit 1
          fi
          echo "Created: ${DMG_NAME}"
          ls -la "${DMG_NAME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: JellyfinMediaPlayer-*.dmg
