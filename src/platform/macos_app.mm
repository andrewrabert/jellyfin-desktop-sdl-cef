// macOS NSApplication subclass implementing CefAppProtocol
// Must be initialized BEFORE SDL_Init for CEF compatibility

#import <Cocoa/Cocoa.h>
#import <Carbon/Carbon.h>  // For kCoreEventClass, kAEReopenApplication
#include "include/cef_application_mac.h"
#include <SDL3/SDL.h>

// Store main window reference for dock click handling
static NSWindow* g_mainWindow = nil;

@interface JellyfinApplication : NSApplication <CefAppProtocol> {
    BOOL handlingSendEvent_;
}
@end

@implementation JellyfinApplication

- (instancetype)init {
    self = [super init];
    if (self) {
        // Register for reopen Apple Event (dock icon click)
        [[NSAppleEventManager sharedAppleEventManager]
            setEventHandler:self
                andSelector:@selector(handleReopenEvent:withReplyEvent:)
              forEventClass:kCoreEventClass
                 andEventID:kAEReopenApplication];
    }
    return self;
}

- (void)handleReopenEvent:(NSAppleEventDescriptor*)event withReplyEvent:(NSAppleEventDescriptor*)reply {
    if (g_mainWindow && [g_mainWindow isMiniaturized]) {
        [g_mainWindow deminiaturize:nil];
    }
}

- (BOOL)isHandlingSendEvent {
    return handlingSendEvent_;
}

- (void)setHandlingSendEvent:(BOOL)handlingSendEvent {
    handlingSendEvent_ = handlingSendEvent;
}

- (void)sendEvent:(NSEvent*)event {
    CefScopedSendingEvent sendingEventScoper;
    [super sendEvent:event];
}

@end

void initMacApplication() {
    // Create our CEF-compatible NSApplication subclass
    // This must be done before SDL_Init, which would create a plain NSApplication
    [JellyfinApplication sharedApplication];

    // Make this a foreground app (shows in dock, gets menubar, receives keyboard)
    [NSApp setActivationPolicy:NSApplicationActivationPolicyRegular];

    // Create basic menu bar with Quit item for Cmd+Q
    NSMenu* menubar = [[NSMenu alloc] init];
    NSMenuItem* appMenuItem = [[NSMenuItem alloc] init];
    [menubar addItem:appMenuItem];
    NSMenu* appMenu = [[NSMenu alloc] init];
    NSMenuItem* quitItem = [[NSMenuItem alloc] initWithTitle:@"Quit"
                                                      action:@selector(terminate:)
                                               keyEquivalent:@"q"];
    [appMenu addItem:quitItem];
    [appMenuItem setSubmenu:appMenu];
    [NSApp setMainMenu:menubar];

    // NOTE: Don't activate here - this runs in helper processes too.
    // Activation happens in activateMacWindow() for main process only.

    NSLog(@"NSApplication class: %@", NSStringFromClass([NSApp class]));
    NSLog(@"Conforms to CefAppProtocol: %@", [NSApp conformsToProtocol:@protocol(CefAppProtocol)] ? @"YES" : @"NO");
}

// Call this after SDL window is created to ensure it can receive keyboard input
void activateMacWindow(SDL_Window* window) {
    [NSApp activateIgnoringOtherApps:YES];

    // Get NSWindow directly from SDL (don't rely on [NSApp mainWindow] being set yet)
    SDL_PropertiesID props = SDL_GetWindowProperties(window);
    NSWindow* ns_window = (__bridge NSWindow*)SDL_GetPointerProperty(
        props, SDL_PROP_WINDOW_COCOA_WINDOW_POINTER, nullptr);
    if (ns_window) {
        [ns_window makeKeyAndOrderFront:nil];
        // Store for dock click handling
        g_mainWindow = ns_window;
    }
}
