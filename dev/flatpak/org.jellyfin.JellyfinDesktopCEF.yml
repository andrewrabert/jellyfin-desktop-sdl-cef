app-id: org.jellyfin.JellyfinDesktopCEF
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: jellyfin-desktop-cef
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --share=ipc
  - --share=network
  - --device=dri
  - --talk-name=org.freedesktop.ScreenSaver
  - --own-name=org.mpris.MediaPlayer2.JellyfinDesktopCEF.*
cleanup:
  - '*.a'
  - '*.la'
  - /bin/event_rpcgen.py
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/man
modules:
  - name: cef
    buildsystem: cmake-ninja
    no-make-install: true
    build-options:
      env:
        CFLAGS: -O2 -pipe -g -fexceptions -fstack-protector-strong -grecord-gcc-switches -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -fno-omit-frame-pointer
        CXXFLAGS: -O2 -pipe -g -fexceptions -fstack-protector-strong -grecord-gcc-switches -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -fno-omit-frame-pointer
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DPROJECT_ARCH=x86_64
    subdir: .
    build-commands:
      - cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DPROJECT_ARCH=x86_64 .
      - ninja libcef_dll_wrapper
      - mkdir -p /app/cef/lib
      - cp -r Release/* /app/cef/lib/
      - cp -r Resources/* /app/cef/lib/
      - cp -r include /app/cef/
      - cp libcef_dll_wrapper/libcef_dll_wrapper.a /app/cef/lib/
    sources:
      - type: archive
        url: https://cef-builds.spotifycdn.com/cef_binary_144.0.12+g1a1008c+chromium-144.0.7559.110_linux64_minimal.tar.bz2
        sha256: 0179617aeb361ca38df0189d39b2983a0f8fe8cad42b299e7e790251aa58b43b

  - name: libmpv
    buildsystem: meson
    config-opts:
      - -Dalsa=disabled
      - -Dbuild-date=false
      - -Ddebug=false
      - -Dlibmpv=true
      - -Dlua=enabled
      - -Dmanpage-build=disabled
    cleanup:
      - /share/applications/mpv.desktop
      - /share/bash-completion
      - /share/doc
      - /share/fish
      - /share/icons/hicolor/*/apps/mpv*
      - /share/zsh
    sources:
      - type: dir
        path: ../../third_party/mpv
    modules:
      - name: luajit
        no-autogen: true
        make-args:
          - BUILDMODE=dynamic
          - PREFIX=${FLATPAK_DEST}
        make-install-args:
          - PREFIX=${FLATPAK_DEST}
        cleanup:
          - /bin
        sources:
          - type: git
            url: https://github.com/openresty/luajit2.git
            tag: v2.1-20251030
            commit: 71fae383f6c4637d64b03a6d0ec76ae8c19d6821
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.-]+)$

      - name: libplacebo
        buildsystem: meson
        config-opts:
          - -Ddemos=false
        cleanup:
          - /include
          - /lib/pkgconfig
        sources:
          - type: git
            url: https://github.com/haasn/libplacebo.git
            tag: v7.351.0
            commit: 3188549fba13bbdf3a5a98de2a38c2e71f04e21e
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$
          - type: patch
            path: vulkan-python-xml.patch

      - name: libXpresent
        buildsystem: autotools
        sources:
          - type: archive
            url: https://xorg.freedesktop.org/archive/individual/lib/libXpresent-1.0.2.tar.xz
            sha256: 4e5b21b4812206a4b223013606ae31170502c1043038777a1ef8f70c09d37602
            x-checker-data:
              type: anitya
              project-id: 17166
              stable-only: true
              url-template: https://xorg.freedesktop.org/archive/individual/lib/libXpresent-$version.tar.xz

      - name: libass
        config-opts:
          - --disable-static
          - --enable-asm
          - --enable-harfbuzz
          - --enable-fontconfig
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.4/libass-0.17.4.tar.gz
            sha256: a886b3b80867f437bc55cff3280a652bfa0d37b43d2aff39ddf3c4f288b8c5a8
            x-checker-data:
              type: anitya
              project-id: 1560
              stable-only: true
              url-template: https://github.com/libass/libass/releases/download/$version/libass-$version.tar.gz

      - name: uchardet
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DBUILD_STATIC=0
          - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
        cleanup:
          - /bin
        sources:
          - type: archive
            url: https://www.freedesktop.org/software/uchardet/releases/uchardet-0.0.8.tar.xz
            sha256: e97a60cfc00a1c147a674b097bb1422abd9fa78a2d9ce3f3fdcc2e78a34ac5f0
            x-checker-data:
              type: anitya
              project-id: 9265
              stable-only: true
              url-template: https://www.freedesktop.org/software/uchardet/releases/uchardet-$version.tar.xz

  - name: jellyfin-desktop-cef
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DEXTERNAL_CEF_DIR=/app/cef
      - -DEXTERNAL_MPV_DIR=/app
    post-install:
      - mkdir -p /app/bin && ln -sf ../jellyfin-desktop-cef /app/bin/jellyfin-desktop-cef
      - install -Dm644 resources/linux/jellyfin-desktop-cef.desktop /app/share/applications/org.jellyfin.JellyfinDesktopCEF.desktop
      - install -Dm644 resources/linux/jellyfin-desktop-cef.svg /app/share/icons/hicolor/scalable/apps/org.jellyfin.JellyfinDesktopCEF.svg
      - install -Dm644 resources/linux/org.jellyfin.JellyfinDesktopCEF.metainfo.xml /app/share/metainfo/org.jellyfin.JellyfinDesktopCEF.metainfo.xml
    sources:
      - type: dir
        path: ../..
